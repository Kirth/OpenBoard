@using Microsoft.AspNetCore.SignalR.Client
@using WhiteboardApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@using WhiteboardApp.Models

<div class="status-bar">
    <div class="status-left">
        <a href="/" class="home-btn" title="Back to Home">
            <span class="home-icon">¬´</span>
        </a>
        <span class="board-title clickable" @onclick="ShowBoardOverview">@BoardName</span>
    </div>
    <div class="status-right">
        <UserMenu />
        <UserPresenceIndicator BoardId="@BoardId" 
                              CurrentUserName="@GetCurrentUserDisplayName()" />
        <button class="theme-toggle-btn" @onclick="ToggleTheme" @onclick:stopPropagation="true" title="Toggle Dark Mode (Ctrl+Shift+D)">
            <span class="theme-icon" id="theme-icon">üåô</span>
        </button>
        <span class="connection-status @(IsConnected ? "connected" : "disconnected")">
            <span class="status-dot"></span>
            @(IsConnected ? "Connected" : "Local Mode")
        </span>
    </div>
</div>


<!-- Board Overview Modal -->
@if (showBoardOverviewModal && boardStats != null)
{
    <div class="modal board-overview-modal" @onclick="HideBoardOverviewModal">
        <div class="modal-content board-overview-content" @onclick:stopPropagation="true">
            <div class="modal-header board-info-header">
                <div class="board-title-row">
                    <span class="board-emoji">@boardStats.BoardEmoji</span>
                    <div class="board-title-info">
                        <h3>@boardStats.BoardName</h3>
                        <div class="board-meta">
                            <span class="meta-item">@boardStats.TotalElements @(boardStats.TotalElements == 1 ? "element" : "elements")</span>
                            <span class="meta-separator">‚Ä¢</span>
                            <span class="meta-item">@GetBoardAccessLevelDisplay(boardStats)</span>
                        </div>
                    </div>
                </div>
                <button class="modal-close" @onclick="HideBoardOverviewModal">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Simple Stats -->
                <div class="board-stats-simple">
                    <div class="stat-row">
                        <span class="stat-label">Created</span>
                        <span class="stat-value">@boardStats.CreatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last modified</span>
                        <span class="stat-value">
                            @if (boardStats.LastContentModifiedAt.HasValue)
                            {
                                @boardStats.LastContentModifiedAt.Value.ToString("MMM dd, yyyy HH:mm")
                            }
                            else
                            {
                                <text>No content yet</text>
                            }
                        </span>
                    </div>
                </div>

                <!-- Content Breakdown -->
                @if (boardStats.ElementsByType.Any())
                {
                    <div class="content-breakdown">
                        <h4>Content</h4>
                        <div class="content-items">
                            @foreach (var elementType in boardStats.ElementsByType.OrderByDescending(kvp => kvp.Value))
                            {
                                <div class="content-item">
                                    <span class="content-type">@elementType.Key</span>
                                    <span class="content-count">@elementType.Value</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Actions -->
                <div class="board-actions">
                    <h4>Actions</h4>
                    <div class="action-grid">
                        <!-- Export group -->
                        <button class="action-button" @onclick="ExportAsHighResPngFromOverview">
                            <span class="action-icon">üñºÔ∏è</span>
                            Export as PNG
                        </button>
                        <button class="action-button" @onclick="ExportAsPdfFromOverview">
                            <span class="action-icon">üìÑ</span>
                            Export as PDF
                        </button>
                        @if (currentUser != null && isOwner)
                        {
                            <button class="action-button" @onclick="ShowJsonExportModal">
                                <span class="action-icon">üìã</span>
                                Export as JSON
                            </button>
                        }

                        <!-- Spacer -->
                        <div class="action-spacer"></div>
                        <div class="action-spacer"></div>

                        <!-- Board management -->
                        <button class="action-button" @onclick="DuplicateBoardFromOverview">
                            <span class="action-icon">üìë</span>
                            Duplicate Board
                        </button>
                        @if (currentUser != null && isOwner)
                        {
                            <button class="action-button" @onclick="ShowBoardSettingsFromOverview">
                                <span class="action-icon">‚öôÔ∏è</span>
                                Board Settings
                            </button>
                            <button class="action-button" @onclick="ShowCollaboratorManagementFromOverview">
                                <span class="action-icon">üë•</span>
                                Manage Collaborators
                            </button>

                            <!-- Spacer -->
                            <div class="action-spacer"></div>

                            <!-- Danger zone -->
                            <button class="action-button action-danger" @onclick="ShowClearConfirmationFromOverview">
                                <span class="action-icon">üóëÔ∏è</span>
                                Clear All Content
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HideBoardOverviewModal">Close</button>
            </div>
        </div>
    </div>
}

<!-- Clear Board Confirmation Modal -->
@if (showClearConfirmModal)
{
    <div class="modal" @onclick="HideClearConfirmModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Clear Board</h3>
                <button class="modal-close" @onclick="HideClearConfirmModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <p><strong>Warning:</strong> This will permanently delete all elements on this board.</p>
                <p>To confirm, please type the exact board name: <strong>@BoardName</strong></p>
                <div class="form-group">
                    <input type="text" class="form-control" @bind="confirmationBoardName" @bind:event="oninput" 
                           placeholder="Enter board name to confirm" autocomplete="off" />
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HideClearConfirmModal">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmClearBoard" disabled="@(!IsConfirmationValid)">Clear Board</button>
            </div>
        </div>
    </div>
}

<!-- Duplicate Board Modal -->
@if (showDuplicateModal)
{
    <div class="modal" @onclick="HideDuplicateModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Duplicate Board</h3>
                <button class="modal-close" @onclick="HideDuplicateModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <p>Create a copy of this board with all its content.</p>
                <div class="form-group">
                    <label>New Board Name</label>
                    <input type="text" class="form-control" @bind="newBoardName" @bind:event="oninput" 
                           placeholder="Enter name for the new board" autocomplete="off" />
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HideDuplicateModal">Cancel</button>
                <button class="btn btn-primary" @onclick="ConfirmDuplicateBoard" disabled="@(!IsNewBoardNameValid)">Duplicate Board</button>
            </div>
        </div>
    </div>
}

<!-- JSON Export Modal -->
@if (showJsonExportModal)
{
    <div class="modal" @onclick="HideJsonExportModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Export Board as JSON</h3>
                <button class="modal-close" @onclick="HideJsonExportModal">&times;</button>
            </div>
            
            <div class="modal-body">
                <p>Export your board data as a structured JSON file with metadata and hash verification.</p>
                
                <div class="form-group">
                    <label><strong>Image Handling</strong></label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="imageMode" value="embedded" checked="@(jsonImageMode == "embedded")" @onchange="@(() => jsonImageMode = "embedded")" />
                            <span>Embed images (larger file, self-contained)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="imageMode" value="referenced" checked="@(jsonImageMode == "referenced")" @onchange="@(() => jsonImageMode = "referenced")" />
                            <span>Reference images (smaller file, requires original images)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-option">
                        <input type="checkbox" @bind="includeCollaborators" />
                        <span>Include collaborator information</span>
                    </label>
                </div>
                
                <div class="export-info">
                    <p><strong>Export will include:</strong></p>
                    <ul>
                        <li>Board metadata with hash verification</li>
                        <li>All board elements and content</li>
                        <li>Board settings and properties</li>
                        @if (includeCollaborators)
                        {
                            <li>Collaborator information</li>
                        }
                        @if (jsonImageMode == "embedded")
                        {
                            <li>Image data (Base64 encoded)</li>
                        }
                        else
                        {
                            <li>Image references (paths only)</li>
                        }
                    </ul>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HideJsonExportModal">Cancel</button>
                <button class="btn btn-primary" @onclick="ExportAsJsonFromModal">Export JSON</button>
            </div>
        </div>
    </div>
}

<!-- Board Settings Modal -->
<BoardSettingsModal IsVisible="@showBoardSettingsModal" 
                   BoardId="@BoardId" 
                   OnClose="HideBoardSettingsModal"
                   OnSettingsSaved="HandleBoardSettingsChanged" />

<!-- Collaborator Management Modal -->
<CollaboratorManagementModal IsVisible="@showCollaboratorModal" 
                            BoardId="@BoardId" 
                            OnClose="HideCollaboratorModal"
                            OnCollaboratorsChanged="OnCollaboratorsChanged" />

@inject IJSRuntime JSRuntime
@inject BoardService BoardService
@inject ExportService ExportService
@inject IUserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider

@code {
    [Parameter] public string BoardName { get; set; } = string.Empty;
    [Parameter] public string BoardId { get; set; } = string.Empty;
    [Parameter] public bool IsConnected { get; set; } = false;
    [Parameter] public EventCallback OnClearBoard { get; set; }
    [Parameter] public EventCallback<string> OnDuplicateBoard { get; set; }
    [Parameter] public EventCallback OnBoardSettingsChanged { get; set; }

    private bool showBoardOverviewModal = false;
    private bool showClearConfirmModal = false;
    private bool showDuplicateModal = false;
    private bool showBoardSettingsModal = false;
    private bool showCollaboratorModal = false;
    private bool showJsonExportModal = false;
    private BoardStats? boardStats = null;
    private string confirmationBoardName = string.Empty;
    private string newBoardName = string.Empty;
    private string jsonImageMode = "embedded";
    private bool includeCollaborators = true;
    private User? currentUser = null;
    private bool isOwner = false;


    private async Task ShowBoardOverview()
    {
        try
        {
            if (Guid.TryParse(BoardId, out var boardGuid))
            {
                boardStats = await BoardService.GetBoardStatsAsync(boardGuid);
                showBoardOverviewModal = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading board stats for overview: {ex.Message}");
        }
    }

    private void HideBoardOverviewModal()
    {
        showBoardOverviewModal = false;
        boardStats = null;
    }

    private async Task DuplicateBoardFromOverview()
    {
        showBoardOverviewModal = false;
        ShowDuplicateModal();
    }

    private async Task ExportAsPngFromOverview()
    {
        showBoardOverviewModal = false;
        try
        {
            if (Guid.TryParse(BoardId, out var boardGuid))
            {
                await ExportService.ExportBoardAsPngAsync(boardGuid);
                await JSRuntime.InvokeVoidAsync("showNotification", "Board exported as PNG successfully!", "success");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PNG: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showNotification", "Failed to export board as PNG", "error");
        }
    }

    private async Task ExportAsPdfFromOverview()
    {
        showBoardOverviewModal = false;
        try
        {
            if (Guid.TryParse(BoardId, out var boardGuid))
            {
                await ExportService.ExportBoardAsPdfAsync(boardGuid);
                await JSRuntime.InvokeVoidAsync("showNotification", "Board exported as PDF successfully!", "success");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting PDF: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showNotification", "Failed to export board as PDF", "error");
        }
    }

    private async Task ExportAsHighResPngFromOverview()
    {
        showBoardOverviewModal = false;
        try
        {
            if (Guid.TryParse(BoardId, out var boardGuid))
            {
                // Export at 2x resolution
                var board = await BoardService.GetBoardAsync(boardGuid);
                var filename = $"{board?.Name ?? "Board"}_HD_{DateTime.Now:yyyyMMdd_HHmmss}.png";
                await JSRuntime.InvokeVoidAsync("exportHighResPng", filename, 2);
                await JSRuntime.InvokeVoidAsync("showNotification", "Board exported as HD PNG successfully!", "success");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting HD PNG: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showNotification", "Failed to export board as HD PNG", "error");
        }
    }

    private void ShowBoardSettingsFromOverview()
    {
        showBoardOverviewModal = false;
        ShowBoardSettings();
    }

    private void ShowCollaboratorManagementFromOverview()
    {
        showBoardOverviewModal = false;
        ShowCollaboratorManagement();
    }

    private void ShowClearConfirmationFromOverview()
    {
        showBoardOverviewModal = false;
        ShowClearConfirmation();
    }

    private void ShowClearConfirmation()
    {
        // Double-check permissions before showing clear confirmation
        if (currentUser != null && isOwner)
        {
            showClearConfirmModal = true;
        }
        else
        {
            Console.WriteLine("Access denied: User is not the board owner");
        }
    }

    private void HideClearConfirmModal()
    {
        showClearConfirmModal = false;
        confirmationBoardName = string.Empty;
    }

    private bool IsConfirmationValid => string.Equals(confirmationBoardName.Trim(), BoardName.Trim(), StringComparison.Ordinal);

    private async Task ConfirmClearBoard()
    {
        if (!IsConfirmationValid)
            return;
            
        showClearConfirmModal = false;
        confirmationBoardName = string.Empty;
        await OnClearBoard.InvokeAsync();
    }

    private async Task ToggleTheme()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("toggleDarkMode");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling theme: {ex.Message}");
        }
    }


    private void ShowDuplicateModal()
    {
        newBoardName = $"Copy of {BoardName}";
        showDuplicateModal = true;
    }

    private void HideDuplicateModal()
    {
        showDuplicateModal = false;
        newBoardName = string.Empty;
    }

    private bool IsNewBoardNameValid => !string.IsNullOrWhiteSpace(newBoardName.Trim());

    private async Task ConfirmDuplicateBoard()
    {
        if (!IsNewBoardNameValid)
            return;
            
        showDuplicateModal = false;
        await OnDuplicateBoard.InvokeAsync(newBoardName.Trim());
        newBoardName = string.Empty;
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserAndRole();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload user role when BoardId changes
        if (!string.IsNullOrEmpty(BoardId))
        {
            await LoadCurrentUserAndRole();
        }
    }

    private async Task LoadCurrentUserAndRole()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                try
                {
                    currentUser = await UserService.GetOrCreateUserAsync(authState.User);
                    Console.WriteLine($"[BoardStatusBar] Loaded authenticated user: {currentUser?.DisplayName}");
                }
                catch (Exception userEx)
                {
                    Console.WriteLine($"[BoardStatusBar] Error loading authenticated user: {userEx.Message}");
                    // Fall back to anonymous user for authenticated sessions with issues
                    currentUser = await UserService.GetAnonymousUserAsync();
                    currentUser.DisplayName = $"Guest-{DateTime.UtcNow.Ticks % 10000}";
                }
                
                // Check if user is owner of this board
                if (Guid.TryParse(BoardId, out var boardGuid) && currentUser != null)
                {
                    var board = await BoardService.GetBoardAsync(boardGuid);
                    isOwner = board != null && board.OwnerId == currentUser.Id;
                }
            }
            else
            {
                // For unauthenticated users, create a guest user
                Console.WriteLine("[BoardStatusBar] User not authenticated, creating guest user");
                currentUser = await UserService.GetAnonymousUserAsync();
                currentUser.DisplayName = $"Guest-{DateTime.UtcNow.Ticks % 10000}";
                isOwner = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[BoardStatusBar] Error loading user role: {ex.Message}");
            // Final fallback - create a basic guest user
            currentUser = new User 
            { 
                DisplayName = $"Guest-{DateTime.UtcNow.Ticks % 10000}",
                Username = "guest"
            };
            isOwner = false;
        }
    }

    private string GetCurrentUserDisplayName()
    {
        if (currentUser?.DisplayName != null && !string.IsNullOrWhiteSpace(currentUser.DisplayName))
        {
            return currentUser.DisplayName;
        }
        
        if (currentUser?.Username != null && !string.IsNullOrWhiteSpace(currentUser.Username))
        {
            return currentUser.Username;
        }
        
        if (currentUser?.Email != null && !string.IsNullOrWhiteSpace(currentUser.Email))
        {
            return currentUser.Email.Split('@')[0];
        }
        
        // Generate a guest name if all else fails
        return $"Guest-{DateTime.UtcNow.Ticks % 10000}";
    }

    private void ShowBoardSettings()
    {
        // Double-check permissions before opening modal
        if (currentUser != null && isOwner)
        {
            showBoardSettingsModal = true;
        }
        else
        {
            Console.WriteLine("Access denied: User is not the board owner");
        }
    }

    private void HideBoardSettingsModal()
    {
        showBoardSettingsModal = false;
    }

    private async Task HandleBoardSettingsChanged()
    {
        // Notify parent component that board settings have changed
        await OnBoardSettingsChanged.InvokeAsync();
        StateHasChanged();
    }

    private void ShowCollaboratorManagement()
    {
        // Double-check permissions before opening modal
        if (currentUser != null && isOwner)
        {
            showCollaboratorModal = true;
        }
        else
        {
            Console.WriteLine("Access denied: User is not the board owner");
        }
    }

    private void HideCollaboratorModal()
    {
        showCollaboratorModal = false;
    }

    private async Task OnCollaboratorsChanged()
    {
        // Optionally refresh board data or notify parent component
        StateHasChanged();
    }

    private string GetBoardAccessLevelDisplay(BoardStats boardStats)
    {
        return boardStats.AccessLevel switch
        {
            BoardAccessLevel.Private => "Private",
            BoardAccessLevel.Unlisted => "Unlisted", 
            BoardAccessLevel.Public => "Public",
            _ => "Unknown"
        };
    }

    private string GetElementTypeIcon(string elementType)
    {
        return elementType.ToLower() switch
        {
            "drawing" => "‚úèÔ∏è",
            "text" => "üìù",
            "shape" => "üîµ",
            "line" => "üìè",
            "stickynote" => "üóíÔ∏è",
            "image" => "üñºÔ∏è",
            _ => "üìÑ"
        };
    }

    private void ShowJsonExportModal()
    {
        showBoardOverviewModal = false;
        showJsonExportModal = true;
    }

    private void HideJsonExportModal()
    {
        showJsonExportModal = false;
    }

    private async Task ExportAsJsonFromModal()
    {
        showJsonExportModal = false;
        try
        {
            if (Guid.TryParse(BoardId, out var boardGuid))
            {
                var exportUrl = $"/api/board/{boardGuid}/export/json?imageMode={jsonImageMode}&includeCollaborators={includeCollaborators}";
                
                // Use a more direct approach to trigger download
                await JSRuntime.InvokeVoidAsync("eval", $@"
                    (function() {{
                        const link = document.createElement('a');
                        link.href = '{exportUrl}';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }})();
                ");
                
                await JSRuntime.InvokeVoidAsync("showNotification", "Board exported as JSON successfully!", "success");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error exporting JSON: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("showNotification", "Failed to export board as JSON", "error");
        }
    }
}