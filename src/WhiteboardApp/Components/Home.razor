@page "/"
@using WhiteboardApp.Services
@using WhiteboardApp.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject BoardService BoardService
@inject IUserService UserService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>OpenBoard</PageTitle>

<link href="css/home.css" rel="stylesheet" />
<script src="js/theme.js"></script>

<header class="container topbar" role="banner">
    <div class="brand">
        <!-- <div class="logo" aria-hidden="true">OB</div> --> 
        OpenBoard
    </div>
    <!--
    <nav class="nav" aria-label="Primary">
        <a href="#features">Features</a>
        <a href="#community">Community</a>
        <a href="#">Docs</a>
    </nav>
    -->
    <div class="user">
        <button id="themeToggle" class="toggle" aria-pressed="true" title="Toggle theme">üåô</button>
        <!--<span class="chip">v0.1 demo</span>-->
        <UserMenu />
    </div>
</header>

<section class="container hero">
    <div>
        <h1>Real‚ÄëTime Collaborative Whiteboarding</h1>
        <p class="sub">Sketch ideas, stack stickies, and plan together from anywhere.</p>

        <BoardSearchInput 
            Placeholder="Enter board name, URL, or ID to join‚Ä¶"
            OnBoardSelected="OnBoardSelected"
            OnDirectJoin="OnDirectJoin"
            OnError="OnSearchError" />
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="hero-error-message">@errorMessage</div>
        }

        <div class="cta-row">
            <button class="btn btn-primary" type="button" @onclick="ShowCreateModal">Create board</button>
            <div class="template-dropdown">

                @if (showTemplateMenu)
                {
                <button class="btn btn-ghost" type="button" @onclick="ToggleTemplateMenu" 
                        aria-expanded="@showTemplateMenu" aria-controls="templateMenu">
                    New from template ‚ñæ
                </button>
                    <div id="templateMenu" class="template-menu" @onclick:stopPropagation="true">
                        <button type="button" @onclick="@(() => CreateFromTemplate("kanban"))">Kanban</button>
                        <button type="button" @onclick="@(() => CreateFromTemplate("retrospective"))">Retrospective</button>
                        <button type="button" @onclick="@(() => CreateFromTemplate("flowchart"))">Flowchart</button>
                        <button type="button" @onclick="@(() => CreateFromTemplate("blank"))">Blank</button>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="hero-art" aria-hidden="true">
        <img src="img/intro.png" alt="Whiteboard collaboration illustration" class="hero-image" />
    </div>
</section>

<main class="container" role="main" @onclick="@(() => { if (showTemplateMenu) showTemplateMenu = false; })">
    <!-- Active Now Section -->
    @if (activeBoards != null && activeBoards.Count > 0)
    {
        <section class="active-now-section" aria-label="Active boards">
            <h2 class="section-title">
                <span class="activity-dot"></span>
                Active Now
            </h2>
            <div class="active-boards-grid">
                @foreach (var board in activeBoards.Take(3))
                {
                    <article class="active-board-card" tabindex="0" @onclick="@(async () => await JoinSpecificBoard(board.Id))">
                        <div class="active-thumb" aria-hidden="true">@board.Emoji</div>
                        <div class="active-meta">
                            <h3>@board.Name <span class="owner-name">‚Ä¢ @(board.Owner?.DisplayName ?? "Unknown")</span></h3>
                        </div>
                    </article>
                }
            </div>
        </section>
    }

    <section class="grid" aria-label="Boards list">
        <AuthorizeView>
            <Authorized>
                <div class="tabs-wrap">
                    <nav class="tabs" aria-label="Board sections">
                        <button class="tab @(activeTab == "my" ? "active" : "")" type="button" @onclick="@(() => SetActiveTab("my"))">My Boards</button>
                        <button class="tab @(activeTab == "public" ? "active" : "")" type="button" @onclick="@(() => SetActiveTab("public"))">Public</button>
                        <button class="tab @(activeTab == "recent" ? "active" : "")" type="button" @onclick="@(() => SetActiveTab("recent"))">Recent</button>
                    </nav>
                    <div class="toolbar" role="region" aria-label="Filters">
                        <input class="input" @bind="searchQuery" @oninput="FilterBoards" placeholder="Search boards" />
                        <select @bind="sortOrder" aria-label="Sort">
                            <option value="updated">Updated</option>
                            <option value="alphabetical">Alphabetical</option>
                            <option value="created">Created</option>
                        </select>
                    </div>
                </div>
                @if (activeTab == "my")
                {
                    @if (displayedBoards != null && displayedBoards.Count > 0)
                    {
                        @foreach (var board in displayedBoards)
                        {
                            <article class="card" tabindex="0" @onclick="@(async () => await JoinSpecificBoard(board.Id))">
                                <div class="thumb" aria-hidden="true">@board.Emoji</div>
                                <div class="meta">
                                    <h3>
                                        @board.Name
                                        <button class="icon-btn" aria-label="Star board" aria-pressed="false" 
                                                @onclick="@(e => ToggleStar(board.Id))" 
                                                @onclick:stopPropagation="true">‚òÖ</button>
                                    </h3>
                                    <div class="row">
                                        <span>Updated @FormatDate(board.UpdatedAt)</span>
                                        <span>‚Ä¢</span>
                                        <span>@GetElementCount(board)</span>
                                    </div>
                                    @if (GetCollaboratorCount(board) > 0)
                                    {
                                        <div class="avatars" aria-label="Collaborators">
                                            @* Placeholder for collaborator avatars *@
                                        </div>
                                    }
                                </div>
                                <div class="actions">
                                    <div class="badge @GetAccessLevelClass(board.AccessLevel)">
                                        @GetAccessLevelIcon(board.AccessLevel) @GetAccessLevelText(board.AccessLevel)
                                    </div>
                                    <button class="icon-btn" title="Share" @onclick="@(e => ShareBoard(board.Id))" @onclick:stopPropagation="true">‚ãØ</button>
                                </div>
                            </article>
                        }
                    }
                    else if (displayedBoards != null)
                    {
                        <div class="empty-state">
                            <p>@(string.IsNullOrEmpty(searchQuery) ? "You haven't created any boards yet." : "No boards match your search.")</p>
                            @if (string.IsNullOrEmpty(searchQuery))
                            {
                                <button class="link-btn" @onclick="ShowCreateModal">Create your first board</button>
                            }
                        </div>
                    }
                    else
                    {
                        @* Loading skeleton *@
                        @for (int i = 0; i < 3; i++)
                        {
                            <article class="card">
                                <div class="thumb skeleton"></div>
                                <div class="meta">
                                    <div class="skeleton" style="height:18px; width:160px; border-radius:6px"></div>
                                    <div class="skeleton" style="height:12px; width:220px; margin-top:10px; border-radius:6px"></div>
                                </div>
                                <div class="actions">
                                    <div class="skeleton" style="height:28px; width:80px; border-radius:999px"></div>
                                </div>
                            </article>
                        }
                    }
                }
                else if (activeTab == "public")
                {
                    @if (publicBoards != null && publicBoards.Count > 0)
                    {
                        @foreach (var board in publicBoards.Where(FilterBoard))
                        {
                            <article class="card" tabindex="0" @onclick="@(async () => await JoinSpecificBoard(board.Id))">
                                <div class="thumb" aria-hidden="true">@board.Emoji</div>
                                <div class="meta">
                                    <h3>
                                        @board.Name
                                        <button class="icon-btn" aria-label="Star board" aria-pressed="false" 
                                                @onclick="@(e => ToggleStar(board.Id))" 
                                                @onclick:stopPropagation="true">‚òÖ</button>
                                    </h3>
                                    <div class="row">
                                        <span>Updated @FormatDate(board.UpdatedAt)</span>
                                        <span>‚Ä¢</span>
                                        <span>@GetStickyCount(board)</span>
                                        <span>‚Ä¢</span>
                                        <span>@(board.Owner?.DisplayName ?? "Unknown")</span>
                                    </div>
                                </div>
                                <div class="actions">
                                    <div class="badge public">üåê Public</div>
                                    <button class="icon-btn" title="Share" @onclick="@(e => ShareBoard(board.Id))" @onclick:stopPropagation="true">‚ãØ</button>
                                </div>
                            </article>
                        }
                    }
                    else if (publicBoards != null)
                    {
                        <div class="empty-state">
                            <p>No public boards available right now.</p>
                        </div>
                    }
                    else
                    {
                        @* Loading skeleton *@
                        @for (int i = 0; i < 3; i++)
                        {
                            <article class="card">
                                <div class="thumb skeleton"></div>
                                <div class="meta">
                                    <div class="skeleton" style="height:18px; width:160px; border-radius:6px"></div>
                                    <div class="skeleton" style="height:12px; width:220px; margin-top:10px; border-radius:6px"></div>
                                </div>
                                <div class="actions">
                                    <div class="skeleton" style="height:28px; width:80px; border-radius:999px"></div>
                                </div>
                            </article>
                        }
                    }
                }
                else if (activeTab == "recent")
                {
                    @if (recentBoards != null && recentBoards.Count > 0)
                    {
                        @foreach (var board in recentBoards.Where(FilterBoard))
                        {
                            <article class="card" tabindex="0" @onclick="@(async () => await JoinSpecificBoard(board.Id))">
                                <div class="thumb" aria-hidden="true">@board.Emoji</div>
                                <div class="meta">
                                    <h3>
                                        @board.Name
                                        <button class="icon-btn" aria-label="Star board" aria-pressed="false" 
                                                @onclick="@(e => ToggleStar(board.Id))" 
                                                @onclick:stopPropagation="true">‚òÖ</button>
                                    </h3>
                                    <div class="row">
                                        <span>Updated @FormatDate(board.UpdatedAt)</span>
                                        <span>‚Ä¢</span>
                                        <span>@GetElementCount(board)</span>
                                        <span>‚Ä¢</span>
                                        <span>@(board.Owner?.DisplayName ?? "Unknown")</span>
                                    </div>
                                </div>
                                <div class="actions">
                                    <div class="badge @GetAccessLevelClass(board.AccessLevel)">
                                        @GetAccessLevelIcon(board.AccessLevel) @GetAccessLevelText(board.AccessLevel)
                                    </div>
                                    <button class="icon-btn" title="Share" @onclick="@(e => ShareBoard(board.Id))" @onclick:stopPropagation="true">‚ãØ</button>
                                </div>
                            </article>
                        }
                    }
                    else if (recentBoards != null)
                    {
                        <div class="empty-state">
                            <p>No recent boards yet. Join or create a board to see it here!</p>
                        </div>
                    }
                    else
                    {
                        @* Loading skeleton *@
                        @for (int i = 0; i < 3; i++)
                        {
                            <article class="card">
                                <div class="thumb skeleton"></div>
                                <div class="meta">
                                    <div class="skeleton" style="height:18px; width:160px; border-radius:6px"></div>
                                    <div class="skeleton" style="height:12px; width:220px; margin-top:10px; border-radius:6px"></div>
                                </div>
                                <div class="actions">
                                    <div class="skeleton" style="height:28px; width:80px; border-radius:999px"></div>
                                </div>
                            </article>
                        }
                    }
                }
            </Authorized>
            <NotAuthorized>
                <div class="public-boards-section">
                    @if (publicBoards != null && publicBoards.Count > 0)
                    {
                        @foreach (var board in publicBoards)
                        {
                            <article class="card" tabindex="0" @onclick="@(async () => await JoinSpecificBoard(board.Id))">
                                <div class="thumb" aria-hidden="true">@board.Emoji</div>
                                <div class="meta">
                                    <h3>@board.Name</h3>
                                    <div class="row">
                                        <span>Updated @FormatDate(board.UpdatedAt)</span>
                                        <span>‚Ä¢</span>
                                        <span>@GetStickyCount(board)</span>
                                        <span>‚Ä¢</span>
                                        <span>@(board.Owner?.DisplayName ?? "Unknown")</span>
                                    </div>
                                </div>
                                <div class="actions">
                                    <div class="badge public">üåê Public</div>
                                </div>
                            </article>
                        }
                    }
                    else if (publicBoards != null)
                    {
                        <div class="empty-state">
                            <p>No public boards available right now.</p>
                        </div>
                    }
                    else
                    {
                        @* Loading skeleton *@
                        @for (int i = 0; i < 3; i++)
                        {
                            <article class="card">
                                <div class="thumb skeleton"></div>
                                <div class="meta">
                                    <div class="skeleton" style="height:18px; width:160px; border-radius:6px"></div>
                                    <div class="skeleton" style="height:12px; width:220px; margin-top:10px; border-radius:6px"></div>
                                </div>
                                <div class="actions">
                                    <div class="skeleton" style="height:28px; width:80px; border-radius:999px"></div>
                                </div>
                            </article>
                        }
                    }
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </section>

    <footer class="container" id="community">
        <p>OpenBoard is open source. <a href="https://github.com/Kirth/OpenBoard">View on GitHub</a></p>
    </footer>
</main>

<div class="toast" id="toast" role="status" aria-live="polite" style="@(showToast ? "display: block;" : "display: none;")">
    @toastMessage
</div>

<!-- Create Board Modal -->
@if (showCreateModal)
{
    <div class="modal" @onclick="HideCreateModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Create Board</h3>
            
            <div class="form-group">
                <label>Title</label>
                <input type="text" @bind="newBoardTitle" placeholder="My Board" />
            </div>
            
            <div class="form-group">
                <label>Emoji</label>
                <div class="emoji-picker-container">
                    <div class="emoji-display" @onclick="ToggleEmojiPicker">
                        <span class="selected-emoji">@selectedEmoji</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    @if (showEmojiPicker)
                    {
                        <div class="emoji-grid" @onclick:stopPropagation="true">
                            @foreach (var emoji in availableEmojis)
                            {
                                <button type="button" class="emoji-option @(selectedEmoji == emoji ? "selected" : "")" 
                                        @onclick="@(() => SelectEmoji(emoji))">
                                    @emoji
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
            
            <div class="form-group">
                <label>Visibility</label>
                <AuthorizeView>
                    <Authorized>
                        <div class="radio-group">
                            <div class="radio-option @(selectedAccessLevel == BoardAccessLevel.Private ? "selected" : "")">
                                <label>
                                    <input type="radio" name="visibility" @onchange="@(() => selectedAccessLevel = BoardAccessLevel.Private)" checked="@(selectedAccessLevel == BoardAccessLevel.Private)" />
                                    <div class="radio-content">
                                        <div class="radio-header">
                                            <i class="fas fa-lock radio-icon"></i>
                                            <span class="radio-title">Private</span>
                                        </div>
                                        <small class="radio-description">Only you and invited collaborators can access</small>
                                    </div>
                                </label>
                            </div>
                            <div class="radio-option @(selectedAccessLevel == BoardAccessLevel.Unlisted ? "selected" : "")">
                                <label>
                                    <input type="radio" name="visibility" @onchange="@(() => selectedAccessLevel = BoardAccessLevel.Unlisted)" checked="@(selectedAccessLevel == BoardAccessLevel.Unlisted)" />
                                    <div class="radio-content">
                                        <div class="radio-header">
                                            <i class="fas fa-link radio-icon"></i>
                                            <span class="radio-title">Unlisted</span>
                                        </div>
                                        <small class="radio-description">Anyone with board ID can access, not listed publicly</small>
                                    </div>
                                </label>
                            </div>
                            <div class="radio-option @(selectedAccessLevel == BoardAccessLevel.Public ? "selected" : "")">
                                <label>
                                    <input type="radio" name="visibility" @onchange="@(() => selectedAccessLevel = BoardAccessLevel.Public)" checked="@(selectedAccessLevel == BoardAccessLevel.Public)" />
                                    <div class="radio-content">
                                        <div class="radio-header">
                                            <i class="fas fa-globe radio-icon"></i>
                                            <span class="radio-title">Public</span>
                                        </div>
                                        <small class="radio-description">Listed publicly, anyone can view</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="radio-group">
                            <div class="radio-option @(selectedAccessLevel == BoardAccessLevel.Unlisted ? "selected" : "")">
                                <label>
                                    <input type="radio" name="visibility" @onchange="@(() => selectedAccessLevel = BoardAccessLevel.Unlisted)" checked="@(selectedAccessLevel == BoardAccessLevel.Unlisted)" />
                                    <div class="radio-content">
                                        <div class="radio-header">
                                            <i class="fas fa-link radio-icon"></i>
                                            <span class="radio-title">Unlisted</span>
                                        </div>
                                        <small class="radio-description">Anyone with board ID can access, not listed publicly</small>
                                    </div>
                                </label>
                            </div>
                            <div class="radio-option @(selectedAccessLevel == BoardAccessLevel.Public ? "selected" : "")">
                                <label>
                                    <input type="radio" name="visibility" @onchange="@(() => selectedAccessLevel = BoardAccessLevel.Public)" checked="@(selectedAccessLevel == BoardAccessLevel.Public)" />
                                    <div class="radio-content">
                                        <div class="radio-header">
                                            <i class="fas fa-globe radio-icon"></i>
                                            <span class="radio-title">Public</span>
                                        </div>
                                        <small class="radio-description">Listed publicly, anyone can view</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="auth-notice">
                            <small class="text-info">
                                <i class="fas fa-info-circle"></i>
                                <a href="/Account/Login" class="link">Sign in</a> to create private boards and manage collaborators
                            </small>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
            
            <div class="modal-actions">
                <button @onclick="HideCreateModal">Cancel</button>
                <button @onclick="CreateNewBoard" disabled="@string.IsNullOrWhiteSpace(newBoardTitle)" class="primary">Create</button>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }
    
    private string newBoardTitle = "";
    private string selectedEmoji = "üìã";
    private bool showEmojiPicker = false;
    private BoardAccessLevel selectedAccessLevel = BoardAccessLevel.Private;
    private bool showCreateModal = false;
    private bool showTemplateMenu = false;
    private bool showToast = false;
    private string toastMessage = "";
    private string errorMessage = "";
    private string activeTab = "my";
    private string searchQuery = "";
    private string sortOrder = "updated";
    
    private List<WhiteboardApp.Models.Board>? publicBoards;
    private List<WhiteboardApp.Models.Board>? activeBoards;
    private List<WhiteboardApp.Models.Board>? userBoards;
    private List<BoardCollaborator>? collaborationBoards;
    private List<WhiteboardApp.Models.Board>? recentBoards;
    private List<WhiteboardApp.Models.Board>? displayedBoards;
    private User? currentUser;
    private HashSet<Guid> starredBoards = new();
    
    private readonly string[] availableEmojis = new[]
    {
        "üìã", "üìù", "üé®", "üí°", "üöÄ", "‚≠ê", "üéØ", "üî•",
        "üìä", "üìà", "üóÇÔ∏è", "üìå", "‚ú®", "üåü", "üí´", "üé™",
        "üé≠", "üé®", "üñºÔ∏è", "üñäÔ∏è", "‚úèÔ∏è", "üñçÔ∏è", "üñåÔ∏è", "üìè"
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            publicBoards = await BoardService.GetPublicBoardsAsync();
            activeBoards = await BoardService.GetActiveBoardsAsync();
        }
        catch (Exception ex)
        {
            // Log error but don't break the page
            Console.WriteLine($"Error loading boards: {ex.Message}");
            publicBoards = new List<WhiteboardApp.Models.Board>();
            activeBoards = new List<WhiteboardApp.Models.Board>();
        }
        
        // Load user's boards if authenticated
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                try 
                {
                    currentUser = await UserService.GetOrCreateUserAsync(authState.User);
                    userBoards = await BoardService.GetUserOwnedBoardsAsync(currentUser);
                    collaborationBoards = currentUser.BoardCollaborations?.ToList() ?? new List<BoardCollaborator>();
                    
                    // Load recent boards using UserService
                    recentBoards = await UserService.GetUserRecentBoardsAsync(currentUser.Id, 5);
                    
                    // Set initial displayed boards
                    UpdateDisplayedBoards();
                }
                catch
                {
                    userBoards = null;
                    collaborationBoards = null;
                    recentBoards = null;
                }
            }
            else
            {
                activeTab = "public";
            }
        }
        else
        {
            activeTab = "public";
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        UpdateDisplayedBoards();
    }

    private void UpdateDisplayedBoards()
    {
        if (activeTab == "my")
        {
            var allMyBoards = new List<WhiteboardApp.Models.Board>();
            if (userBoards != null) allMyBoards.AddRange(userBoards);
            if (collaborationBoards != null) allMyBoards.AddRange(collaborationBoards.Select(c => c.Board));
            
            displayedBoards = allMyBoards
                .Where(FilterBoard)
                .OrderBy(b => sortOrder switch
                {
                    "alphabetical" => b.Name,
                    "created" => b.CreatedAt.ToString(),
                    _ => b.UpdatedAt.ToString()
                })
                .ToList();
                
            if (sortOrder == "updated" || sortOrder == "created")
            {
                displayedBoards.Reverse();
            }
        }
    }

    private bool FilterBoard(WhiteboardApp.Models.Board board)
    {
        if (string.IsNullOrEmpty(searchQuery)) return true;
        return board.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase);
    }

    private void FilterBoards()
    {
        UpdateDisplayedBoards();
    }

    private void SortBoards()
    {
        UpdateDisplayedBoards();
    }

    private async Task CreateNewBoard()
    {
        if (string.IsNullOrWhiteSpace(newBoardTitle))
            return;

        User user;
        
        // Check if user is authenticated
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                try 
                {
                    user = await UserService.GetOrCreateUserAsync(authState.User);
                }
                catch
                {
                    user = await UserService.GetAnonymousUserAsync();
                }
            }
            else
            {
                user = await UserService.GetAnonymousUserAsync();
            }
        }
        else
        {
            user = await UserService.GetAnonymousUserAsync();
        }

        var board = await BoardService.CreateBoardAsync(newBoardTitle.Trim(), user, selectedAccessLevel, selectedEmoji);
        
        // Refresh user boards list if user is authenticated
        if (user.SubjectId != "anonymous-user")
        {
            userBoards = await BoardService.GetUserOwnedBoardsAsync(user);
            currentUser = user;
            collaborationBoards = currentUser.BoardCollaborations?.ToList() ?? new List<BoardCollaborator>();
            
            // Refresh recent boards using UserService
            recentBoards = await UserService.GetUserRecentBoardsAsync(user.Id, 5);
            UpdateDisplayedBoards();
        }
        
        HideCreateModal();
        Navigation.NavigateTo($"/board/{board.Id}");
    }

    private async Task CreateFromTemplate(string template)
    {
        showTemplateMenu = false;
        // For now, just create a blank board with a template-specific emoji
        var templateEmoji = template switch
        {
            "kanban" => "üìã",
            "retrospective" => "üîÑ",
            "flowchart" => "üîÄ",
            _ => "üìù"
        };
        
        selectedEmoji = templateEmoji;
        newBoardTitle = $"{template.Substring(0, 1).ToUpper()}{template.Substring(1)} Board";
        ShowCreateModal();
        StateHasChanged(); // Ensure UI updates
    }

    private async Task OnBoardSelected(WhiteboardApp.Models.Board board)
    {
        await JoinSpecificBoard(board.Id);
    }

    private async Task OnDirectJoin(string boardIdentifier)
    {
        // Validate GUID format
        if (!Guid.TryParse(boardIdentifier, out var boardGuid))
        {
            errorMessage = "Invalid board ID format";
            return;
        }

        // Check if board exists and user can access it
        var board = await BoardService.GetBoardAsync(boardGuid);
        if (board == null)
        {
            errorMessage = "Board not found";
            return;
        }

        // Check access permissions
        var canAccess = board.AccessLevel == BoardAccessLevel.Public;
        
        if (!canAccess && AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                try
                {
                    var user = await UserService.GetOrCreateUserAsync(authState.User);
                    canAccess = board.OwnerId == user.Id || 
                               board.Collaborators?.Any(c => c.UserId == user.Id) == true ||
                               board.AccessLevel == BoardAccessLevel.Unlisted;
                }
                catch
                {
                    // If user service fails, keep canAccess as false
                }
            }
        }

        if (!canAccess)
        {
            errorMessage = "Access denied to this board";
            return;
        }

        await JoinSpecificBoard(boardGuid);
    }

    private void OnSearchError(string error)
    {
        errorMessage = error;
        StateHasChanged();
    }

    private async Task JoinSpecificBoard(Guid id)
    {
        // Track board access for authenticated users
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                try
                {
                    var user = await UserService.GetOrCreateUserAsync(authState.User);
                    await BoardService.TrackBoardAccessAsync(user.Id, id, isJoin: false);
                }
                catch
                {
                    // Ignore tracking errors
                }
            }
        }

        Navigation.NavigateTo($"/board/{id}");
    }

    private void ShowCreateModal()
    {
        newBoardTitle = "";
        selectedEmoji = "üìã";
        selectedAccessLevel = BoardAccessLevel.Private;
        showEmojiPicker = false;
        showCreateModal = true;
    }

    private void HideCreateModal()
    {
        showCreateModal = false;
        newBoardTitle = "";
        selectedEmoji = "üìã";
        selectedAccessLevel = BoardAccessLevel.Private;
        showEmojiPicker = false;
    }
    
    private void ToggleEmojiPicker()
    {
        showEmojiPicker = !showEmojiPicker;
    }
    
    private void SelectEmoji(string emoji)
    {
        selectedEmoji = emoji;
        showEmojiPicker = false;
    }

    private void ToggleTemplateMenu()
    {
        showTemplateMenu = false; // !showTemplateMenu;
    }


    private void ToggleStar(Guid boardId)
    {
        if (starredBoards.Contains(boardId))
        {
            starredBoards.Remove(boardId);
        }
        else
        {
            starredBoards.Add(boardId);
        }
    }

    private void ShareBoard(Guid boardId)
    {
        toastMessage = "Link copied";
        showToast = true;
        StateHasChanged();
        
        // Hide toast after 1.4 seconds
        Task.Delay(1400).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private string FormatDate(DateTime date)
    {
        var timeAgo = DateTime.UtcNow - date;
        if (timeAgo.TotalMinutes < 1) return "now";
        if (timeAgo.TotalHours < 1) return $"{(int)timeAgo.TotalMinutes}m ago";
        if (timeAgo.TotalDays < 1) return $"{(int)timeAgo.TotalHours}h ago";
        if (timeAgo.TotalDays < 7) return $"{(int)timeAgo.TotalDays}d ago";
        return date.ToString("M/d");
    }


    private string GetStickyCount(WhiteboardApp.Models.Board board)
    {
        var count = board.Elements?.Count ?? 0;
        return count == 1 ? "1 item" : $"{count} items";
    }

    private string GetElementCount(WhiteboardApp.Models.Board board)
    {
        var count = board.Elements?.Count ?? 0;
        return count == 1 ? "1 item" : $"{count} items";
    }

    private int GetCollaboratorCount(WhiteboardApp.Models.Board board)
    {
        var count = board.Collaborators?.Count ?? 0;
        return count;
    }

    private string GetAccessLevelClass(BoardAccessLevel level)
    {
        return level switch
        {
            BoardAccessLevel.Public => "public",
            BoardAccessLevel.Private => "private",
            BoardAccessLevel.Unlisted => "unlisted",
            _ => ""
        };
    }

    private string GetAccessLevelIcon(BoardAccessLevel level)
    {
        return level switch
        {
            BoardAccessLevel.Public => "üåê",
            BoardAccessLevel.Private => "üîí",
            BoardAccessLevel.Unlisted => "üîó",
            _ => ""
        };
    }

    private string GetAccessLevelText(BoardAccessLevel level)
    {
        return level switch
        {
            BoardAccessLevel.Public => "Public",
            BoardAccessLevel.Private => "Private",
            BoardAccessLevel.Unlisted => "Unlisted",
            _ => ""
        };
    }
}
